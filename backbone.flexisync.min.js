/*! backbone.flexisync v0.1.0 (2013-04-13) */
(function(e,t){"function"==typeof define&&define.amd?define(["backbone","jquery","underscore"],function(e,r,s){return e.Flexisync=t(e,r,s),e.Flexisync}):e.Backbone.Flexisync=t(e.Backbone,e.jQuery,e._)})(this,function(e,t,r){var s=function(){var e={};e._get=function(e){var t=localStorage.getItem("flexisync:data:"+e);return"string"==typeof t?JSON.parse(t):void 0},e.get=function(t){var r={data:e._get(t),cachedata:{data:e.cachedata,keys:e.cachekeys}};return r.cachedata[t]=r.data,e.cachedata={},e.cachekeys=[],r.data?r:void 0},e.set=function(t,s){localStorage.setItem("flexisync:data:"+t,JSON.stringify(s)),e.keys=r.uniq(e.keys.concat([t])),e.cachekeys=r.uniq(e.cachekeys.concat([t])),localStorage.setItem("flexisync:keys",JSON.stringify(e.keys))};var t=JSON.parse(localStorage.getItem("flexisync:keys"))||[];return r.extend(e,{keys:[].concat(t),cachekeys:[].concat(t),cachedata:{}}),r.each(e.keys,function(t){var r=e._get(t);r&&(e.cachedata[t]=r)}),e}(),a=function(){var e={data:{}};return e.get=function(e){return this.data[e]?{data:this.data[e]}:void 0},e.set=function(e,t){this.data[e]=t},e}(),o=function(e){var t={async:!0,availabledata:{},datasources:{},datasourcecount:0};return e.support.cors=!0,t.get=function(r,s){var a,o,i=e.Deferred();return(a=this.getSource(r))?(s=s||{},s.xhr=s.xhr||t.createProgressXhr(i),o=t.createRequest(a,s),a.remoterequest=o,o.fail(function(e,t,r){i.reject(r)}),o.done(function(e,t,s){if(s&&s.data[r]){var o={keys:a.returnData,data:s.data};i.resolve(s.data[r],o)}else{var c=s&&s.error||new n.Error(503,"Remote data fetching failed.");i.reject(c)}}),o.always(function(){a.remoterequest=void 0}),i.promise()):i.reject(new n.Error(404,"No datasource for data '"+r+"'")).promise()},t.set=function(){},t.createRequest=function(s,a){var o;if(s.remoterequest)return s.remoterequest;var n=s.url;return a=e.extend(a,{type:"GET",url:r.isFunction(n)?n.apply(s,a.parameters):n,dataType:"json"}),o=e.ajax(a),o.datasource=s,o.done(t.processRequest),o},t.processRequest=function(e,t,r){try{r.data=r.datasource.parse(e)}catch(s){s instanceof n.Error?r.error=s:(r.error=new n.Error(503,"Raw data parsing failed.",s),n.debug&&s.name&&s.message&&console.log(s.name+": "+s.message))}},t.createProgressXhr=function(e){return function(){var t=new window.XMLHttpRequest;return t.addEventListener("progress",function(t){t.lengthComputable&&e.notify(t.loaded,t.total)},!1),t}},t.addSource=function(e){var t;return this.validateSource(e)?(this.datasourcecount++,t=this.datasourcecount,this.datasources[t]={url:e.url,returnData:e.returnData,parse:e.parse},r.each(e.returnData,function(e){this.availabledata[e]=t},this),void 0):(n.debug&&console.log("Flexisync: datasource invalid.",e),!1)},t.validateSource=function(e){return e&&(r.isString(e.url)||r.isFunction(e.url))&&r.isArray(e.returnData)&&e.returnData.length>0&&r.isFunction(e.parse)?!0:!1},t.getSource=function(e){var t=this.availabledata[e];return t?this.datasources[t]:void 0},t}(jQuery),n={matchers:[],datastores:{memory:a,localstorage:s,remote:o},debug:!1,options:{urlprefix:"flexisync://",fetchFrom:null,saveTo:null,cacheTo:null}};return n.activate=function(){e.sync!==n.sync&&(n.nativesync=e.sync,e.sync=n.sync)},n.deactivate=function(){n.nativesync&&(e.sync=nativesync)},n.sync=function(e,t,s){var a,o,i,c,u;return c=s,s.from&&(s.fetchFrom=s.from),s.to&&(s.saveTo=s.to),t=t||{},u={},t.fetchFrom&&(u.fetchFrom=t.fetchFrom),t.saveTo&&(u.saveTo=t.saveTo),t.cacheTo&&(u.cacheTo=t.cacheTo),s=r.extend({},n.options,u,s),a=r.isFunction(t.url)?t.url():t.url,s.url=s.url||a,o=n.RequestMatcher.matchUrl(e,s.url),o?(i=new n.Request(o,t,s),i.process(),i):n.nativesync(e,t,c)},n.Error=function(e,t,r){return this.status=e||503,this.statusText=t||"Unspecified error.",r&&(this.raw=r),this},n.Request=function(e,s,a){return r.bindAll(this),r.extend(this,new t.Deferred),this.timing={start:+new Date},this.matcher=e,this.model=s,this.options=a,this.requests=[],this.params=n.RequestMatcher.getUrlParameters(a.url,e),this.options.parameters=r.isFunction(e.parameters)?e.parameters.apply(e,this.params):{},this.timing.matched=+new Date,this},n.Request.prototype.process=function(){return r.isArray(this.matcher.requiredData)&&0!==this.matcher.requiredData.length?(r.each(this.matcher.requiredData,this.addDataFetcher),t.when.apply(t,this.requests).always(this.calculateTimings).done(this.tryResolve).fail(this.doReject),this.promise()):(this.tryResolve(),this.promise())},n.Request.prototype.addDataFetcher=function(e){var t=new n.Data(e,this.options);t.progress(this.trackProgress),this.requests.push(t),t.fetch()},n.Request.prototype.calculateTimings=function(){this.timing.requesttime=+new Date-this.timing.start},n.Request.prototype.tryResolve=function(){var e,t={};this.timing.fetched=+new Date,this.sources=r.map(this.requests,function(e){return e.key+": "+e.source}),r.each(this.requests,function(e){t[e.key]=e.data}),this.params.unshift(t);try{result=this.matcher.parse.apply(n,this.params),this.doResolve(result)}catch(s){n.debug&&s.name&&s.message&&console.log(s.name+": "+s.message),e=s instanceof n.Error?s:new n.Error(500,"Data parsing failed.",s),this.doReject(e)}},n.Request.prototype.doResolve=function(e){n.debug&&console.log("%cFlexisync Success ("+this.timing.requesttime+"ms): "+this.options.url,"color: green","["+this.sources.join(", ")+"]: ",e),this.options.success&&this.options.success(e),this.model.trigger("sync",this.model,e,this.options),this.resolve(this.model,e,this.options),this.model.trigger("sync:done",e)},n.Request.prototype.doReject=function(e){n.debug&&console.log("%cFlexisync Error ("+this.timing.requesttime+"ms): "+this.options.url,"color: red",e),this.options.error&&this.options.error(e),this.model.trigger("error",this.model,e,this.options),this.reject(this.model,e,this.options)},n.Request.prototype.trackProgress=function(){var e=r.reduce(this.requests,function(e,t){return e+t.progress.completed},0),t=r.reduce(this.requests,function(e,t){return e+t.progress.total},0);this.model.trigger("sync:progress",e,t),this.notify(e,t)},n.Data={},n.Data=function(e,s){return r.bindAll(this),r.extend(this,new t.Deferred),this.key=e,this.options=r.extend(r.clone(s),{success:void 0,error:void 0,parameters:s.parameters[e]||[]}),this},n.Data.prototype={completed:0,total:0},n.Data.prototype.fetch=function(){var e;if(e=this.options.fetchFrom,e="string"==typeof e?[e]:e,!r.isArray(e)||1>e.length)return this.reject(new n.Error(503,"No datastores configured."));for(var t=0;e.length>t&&!this.fetchFrom(e[t]);t++);return this.source?this:this.reject(new n.Error(404,"No datastore has the requested data."))},n.Data.prototype.fetchFrom=function(e){var t=n.datastores[e];if(!t||!t.get)return!1;var r=t.get(this.key,this.options);return!r||r instanceof n.Error?!1:(this.source=e,t.async?r.progress(this.updateProgress,this.notify).done(this.cacheData,this.resolve).fail(this.reject):(this.cacheData(r.data,r.cachedata),this.resolve(r.data)),!0)},n.Data.prototype.updateProgress=function(e,t){this.completed=e,this.total=t},n.Data.prototype.cacheData=function(e,t){this.data=e,t&&r.isArray(this.options.cacheTo)&&r.each(this.options.cacheTo,function(e){if(e!==this.source){var s=n.datastores[e];r.each(t.keys,function(e){s.set(e,t.data[e])})}})},n.RequestMatcher={},n.RequestMatcher.register=function(e){return r.isArray(e)?r.each(e,n.RequestMatcher.register):n.RequestMatcher.validate(e)?(n.matchers.push(e),!0):!1},n.RequestMatcher.validate=function(e){return e?e.pattern&&r.isFunction(e.pattern.exec)?r.isFunction(e.parse)?e.requiredData&&!r.isArray(e.requiredData)?!1:!r.find(n.matchers,function(t){return""+t.pattern==""+e.pattern?!0:void 0}):!1:!1:!1},n.RequestMatcher.matchUrl=function(e,t){return"read"===e&&t&&/^flexisync:\/\//.test(t)?(t=t.replace(n.options.urlprefix,""),r.find(n.matchers,function(e){return e.pattern.test(t)?e:!1})):!1},n.RequestMatcher.getUrlParameters=function(e,t){e=e.replace(n.options.urlprefix,"");var r=t.pattern.exec(e);return r&&r.shift(),r},n});