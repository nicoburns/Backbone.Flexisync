/*! backbone.flexisync v0.1.0 (2013-04-12) */
(function(t,e){"function"==typeof define&&define.amd?define(["backbone","jquery","underscore"],function(t,r,s){return t.Flexisync=e(t,r,s),t.Flexisync}):t.Backbone.Flexisync=e(t.Backbone,t.jQuery,t._)})(this,function(t,e,r){var s=function(){var t={};t._get=function(t){var e=localStorage.getItem("flexisync:data:"+t);return"string"==typeof e?JSON.parse(e):void 0},t.get=function(e){var r={data:t._get(e),cachedata:{data:t.cachedata,keys:t.cachekeys}};return r.cachedata[e]=r.data,t.cachedata={},t.cachekeys=[],r.data?r:void 0},t.set=function(e,s){localStorage.setItem("flexisync:data:"+e,JSON.stringify(s)),t.keys=r.uniq(t.keys.concat([e])),t.cachekeys=r.uniq(t.cachekeys.concat([e])),localStorage.setItem("flexisync:keys",JSON.stringify(t.keys))};var e=JSON.parse(localStorage.getItem("flexisync:keys"))||[];return r.extend(t,{keys:[].concat(e),cachekeys:[].concat(e),cachedata:{}}),r.each(t.keys,function(e){var r=t._get(e);r&&(t.cachedata[e]=r)}),t}(),a=function(){var t={data:{}};return t.get=function(t){return this.data[t]?{data:this.data[t]}:void 0},t.set=function(t,e){this.data[t]=e},t}(),o=function(t){var e={async:!0,availabledata:{},datasources:{},datasourcecount:0};return t.support.cors=!0,e.get=function(r,s){var a,o,i=t.Deferred();return(a=this.getSource(r))?(s=s||{},s.xhr=s.xhr||e.createProgressXhr(i),o=e.createRequest(a,s),a.remoterequest=o,o.fail(function(t,e,r){i.reject(r)}),o.done(function(t,e,s){if(s&&s.data[r]){var o={keys:a.returnData,data:s.data};i.resolve(s.data[r],o)}else{var c=s&&s.error||new n.Error(503,"Remote data fetching failed.");i.reject(c)}}),o.always(function(){a.remoterequest=void 0}),i.promise()):i.reject().promise()},e.set=function(){},e.createRequest=function(r,s){var a;return r.remoterequest?r.remoterequest:(s=t.extend(s,{type:"GET",url:r.url,dataType:"json"}),a=t.ajax(s),a.datasource=r,a.done(e.processRequest),a)},e.processRequest=function(t,e,r){try{r.data=r.datasource.parse(t)}catch(s){s instanceof n.Error?r.error=s:(r.error=new n.Error(503,"Raw data parsing failed.",s),n.debug&&s.name&&s.message&&console.log(s.name+": "+s.message))}},e.createProgressXhr=function(t){return function(){var e=new window.XMLHttpRequest;return e.addEventListener("progress",function(e){e.lengthComputable&&t.notify(e.loaded,e.total)},!1),e}},e.addSource=function(t){var e;return this.validateSource(t)?(this.datasourcecount++,e=this.datasourcecount,this.datasources[e]={url:t.url,returnData:t.returnData,parse:t.parse},r.each(t.returnData,function(t){this.availabledata[t]=e},this),void 0):!1},e.validateSource=function(t){return t&&r.isString(t.url)&&r.isArray(t.returnData)&&t.returnData.length>0&&r.isFunction(t.parse)?!0:!1},e.getSource=function(t){var e=this.availabledata[t];return e?this.datasources[e]:void 0},e}(jQuery),n={matchers:[],datastores:{memory:a,localstorage:s,remote:o},debug:!1,options:{urlprefix:"flexisync://",fetchFrom:null,saveTo:null,cacheTo:null}};return n.activate=function(){t.sync!==n.sync&&(n.nativesync=t.sync,t.sync=n.sync)},n.deactivate=function(){n.nativesync&&(t.sync=nativesync)},n.sync=function(t,e,s){var a,o,i,c,u;return c=s,s.from&&(s.fetchFrom=s.from),s.to&&(s.saveTo=s.to),e=e||{},u={},e.fetchFrom&&(u.fetchFrom=e.fetchFrom),e.saveTo&&(u.saveTo=e.saveTo),e.cacheTo&&(u.cacheTo=e.cacheTo),s=r.extend({},n.options,u,s),a=r.isFunction(e.url)?e.url():e.url,s.url=s.url||a,o=n.RequestMatcher.matchUrl(t,s.url),o?(i=new n.Request(o,e,s),i.process(),i):n.nativesync(t,e,c)},n.Error=function(t,e,r){return this.status=t||503,this.statusText=e||"Unspecified error.",r&&(this.raw=r),this},n.Request=function(t,s,a){return r.bindAll(this),r.extend(this,new e.Deferred),this.timing={start:+new Date},this.matcher=t,this.model=s,this.options=a,this.requests=[],this.params=n.RequestMatcher.getUrlParameters(a.url,t),this.timing.matched=+new Date,this},n.Request.prototype.process=function(){return r.isArray(this.matcher.requiredData)&&0!==this.matcher.requiredData.length?(r.each(this.matcher.requiredData,this.addDataFetcher),e.when.apply(e,this.requests).always(this.calculateTimings).done(this.tryResolve).fail(this.doReject),this.promise()):(this.tryResolve(),this.promise())},n.Request.prototype.addDataFetcher=function(t){var e=new n.Data(t,this.options);e.progress(this.trackProgress),this.requests.push(e),e.fetch()},n.Request.prototype.calculateTimings=function(){this.timing.requesttime=+new Date-this.timing.start},n.Request.prototype.tryResolve=function(){var t,e={};this.timing.fetched=+new Date,this.sources=r.map(this.requests,function(t){return t.key+": "+t.source}),r.each(this.requests,function(t){e[t.key]=t.data}),this.params.unshift(e);try{result=this.matcher.parse.apply(n,this.params),this.doResolve(result)}catch(s){n.debug&&s.name&&s.message&&console.log(s.name+": "+s.message),t=s instanceof n.Error?s:new n.Error(500,"Data parsing failed.",s),this.doReject(t)}},n.Request.prototype.doResolve=function(t){n.debug&&console.log("%cFlexisync Success ("+this.timing.requesttime+"ms): "+this.options.url,"color: green","["+this.sources.join(", ")+"]: ",t),this.options.success&&this.options.success(t),this.model.trigger("sync",this.model,t,this.options),this.resolve(this.model,t,this.options),this.model.trigger("sync:done",t)},n.Request.prototype.doReject=function(t){n.debug&&console.log("%cFlexisync Error ("+this.timing.requesttime+"ms): "+this.options.url,"color: red",t),this.options.error&&this.options.error(t),this.model.trigger("error",this.model,t,this.options),this.reject(this.model,t,this.options)},n.Request.prototype.trackProgress=function(){var t=r.reduce(this.requests,function(t,e){return t+e.progress.completed},0),e=r.reduce(this.requests,function(t,e){return t+e.progress.total},0);this.model.trigger("sync:progress",t,e),this.notify(t,e)},n.Data={},n.Data=function(t,s){return r.bindAll(this),r.extend(this,new e.Deferred),this.key=t,this.options=r.extend(r.clone(s),{success:void 0,error:void 0}),this},n.Data.prototype={completed:0,total:0},n.Data.prototype.fetch=function(){var t;if(t=this.options.fetchFrom,t="string"==typeof t?[t]:t,!r.isArray(t)||1>t.length)return this.reject(new n.Error(503,"No datastores configured."));for(var e=0;t.length>e&&!this.fetchFrom(t[e]);e++);return this.source?this:this.reject(new n.Error(404,"No datastore has the requested data."))},n.Data.prototype.fetchFrom=function(t){var e=n.datastores[t];if(!e||!e.get)return!1;var r=e.get(this.key,this.options);return!r||r instanceof n.Error?!1:(this.source=t,e.async?r.progress(this.updateProgress,this.notify).done(this.cacheData,this.resolve).fail(this.reject):(this.cacheData(r.data,r.cachedata),this.resolve(r.data)),!0)},n.Data.prototype.updateProgress=function(t,e){this.completed=t,this.total=e},n.Data.prototype.cacheData=function(t,e){this.data=t,e&&r.isArray(this.options.cacheTo)&&r.each(this.options.cacheTo,function(t){if(t!==this.source){var s=n.datastores[t];r.each(e.keys,function(t){s.set(t,e.data[t])})}})},n.RequestMatcher={},n.RequestMatcher.register=function(t){return r.isArray(t)?r.each(t,n.RequestMatcher.register):n.RequestMatcher.validate(t)?(n.matchers.push(t),!0):!1},n.RequestMatcher.validate=function(t){return t?t.pattern&&r.isFunction(t.pattern.exec)?r.isFunction(t.parse)?t.requiredData&&!r.isArray(t.requiredData)?!1:!r.find(n.matchers,function(e){return""+e.pattern==""+t.pattern?!0:void 0}):!1:!1:!1},n.RequestMatcher.matchUrl=function(t,e){return"read"===t&&e&&/^flexisync:\/\//.test(e)?(e=e.replace(n.options.urlprefix,""),r.find(n.matchers,function(t){return t.pattern.test(e)?t:!1})):!1},n.RequestMatcher.getUrlParameters=function(t,e){t=t.replace(n.options.urlprefix,"");var r=e.pattern.exec(t);return r&&r.shift(),r},n});